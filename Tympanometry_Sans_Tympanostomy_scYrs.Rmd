---
title: "Tympanometry Sans Tympanostomy and CHL - Static Admittance~Age"
author: "E Bryan Crenshaw III"
date: "August 7, 2015"
output: html_document
---

**Objective**: [Using scripts designed to examine Static Admittance in 3 age groups](Tympanometry_Sans_Tympanostomy_sc2.html), we will examine Static Admittances in years. The initial yearly groupings, young (age >= 0.5 & age < 3), middle (age >= 3 & age <= 15) and older (age >= 15), were based on clinical practice flow.  We will address whether there are any incontinuities in the development over time by examining the values in bins of every 2 years from 0.5 to 18.5 years.   

**Links to Main Observations**
<ul>
<li><a href="#basic_stats">Basic Statistics of Age Ranges</a></li>
<li><a href="#psd_plot">Probability Density Function in Age Ranges</a></li>
<li><a href="#mean_plot">Graph of Mean in Age Ranges</a></li>
<li><a href="#ci_plot">Graph of 90% Confidence Interval in Age Ranges</a></li>
<li><a href="#n_plot">Graph of Number of Observations in Age Ranges</a></li>
<li><a href="#sd_plot">Graph of Standard Deviation in Age Ranges</a></li>
<li><a href="#observations">Synopsis of Observations</a></li>
</ul>

**Approach**: Load 'tympnorms' dataset (tympnorms2.RData) of patients with PTA between 0 and 15 dB from [Tympanometry Download2](Tympanometry Download2.html). This dataset restricts the initial dataset further by eliminating patients with an ICD-9 code indicating any pathology of the tympanic membrane or any form of Conductive Hearing Loss. Load data frame with data from patients who've had a tympanostomy from [Tympanostomy Patients Download](..//Hearing%20and%20Tympanostomy/Tympanostomy_-_Load_Data.html). Remove patients with tympanostomies from the tympnorm dataset.  Also, remove patients from Vandy that have been given "B" and "C" type tympanograms.  Rerun the [analyses done to evaluate ECVs](Tympanometry_Sans_Tympanostomy_y_Outliers.html) that have been modified to evaluate the SC column of the dataframe:


```{r LoadData}
# Data from patients with normal PTAs and cleaned of tympanic membrane pathology and CHL
load("data/tympnorms2.RData")
# Data from patients who have had tympanostomies
load("../Hearing and Tympanostomy/data/tympanostomy_procs.RData")
# Eliminate tympanostomy patients from the 'tympnorms' dataset
tympnorms.sanstubes <- subset(tympnorms, !tympnorms$Patient.Alias %in% tympanostomy.procs$Patient.Alias, )
# Remove rows with Tymp "type" of B or C
tympnorms.sanstubes <- subset(tympnorms.sanstubes, !grepl("B", type) & !grepl("C", type),)
```

####<a name="basic_stats"></a>Statistical Analyses By Year:####

```{r BasicStats}
# Load 'psych' library for describe() function
library("psych", lib.loc="/Library/Frameworks/R.framework/Versions/3.0/Resources/library")
#ages vector will be used to set age ranges
ages <- seq.int(0.5,18.5,2) # Set age range (Initially 0.5 to 18.5 by 2 years)
#zero out variables used to keep running account of statistics for each age range
sc_means <- sc_n  <- sc_5pct <- sc_95pct <- sc_sd  <- 0
# Use for loop to subset each age range, and then print out 'describe' and 'quantile' statistics
for (i in (seq_along(ages)-1)) {
  if (i > 0) {
    tympnorms.sanstubes_ages <- subset(tympnorms.sanstubes, age >= ages[i] & age < ages[i + 1],)
    cat("Ages", ages[i], "to", ages[i+1], ":", "\n")
    cat("Basic Statistics on Static Admittance", "\n")
    scages.describe <- describe(tympnorms.sanstubes_ages$sc)
    sc_means[i] <- scages.describe[["mean"]]
    sc_n[i] <- scages.describe[["n"]]
    sc_sd[i] <- scages.describe[["sd"]]
    print(scages.describe);cat("", sep="\n\n")
    scquant <- quantile(tympnorms.sanstubes_ages$sc,  probs = c(2.5, 5, 10, 50, 90, 95, 97.5, NA)/100, na.rm = TRUE)
    sc_5pct[i]  <- scquant[["5%"]]
    sc_95pct[i] <- scquant[["95%"]]
    cat("Quantiles of Children", ages[i], "to", ages[i+1], ":");cat("", sep="\n")
    print(scquant)
    ;cat("---------", sep="\n");cat("", sep="\n")
    } else {next}
}
#Make data frame with stats to graph in ggplot2
sc_stats <- data.frame(age = ages[1:9], means = sc_means, n = sc_n, sd = sc_sd, pct5 = sc_5pct, pct95 = sc_95pct)

```

<a name = "psd_plot"></a>
```{r PlotAgeSC}
# Plot the probability density function in the age ranges
for (i in (seq_along(ages)-1)) {
    tympnorms.sanstubes_ages <- subset(tympnorms.sanstubes, age >= ages[i] & age < ages[i + 1],)
  if (i == 0 ) {
    next
    } else if (i == 1) {
      plot(density(tympnorms.sanstubes_ages$sc, na.rm = TRUE), main = "Static Admittance of Children with PTA <=15 dB & No Pathology", xlab = "Static Admittance (ml)", ylim = c(0,4))
      } else {
        lines(density(tympnorms.sanstubes_ages$sc, na.rm = TRUE), col = i)
    }
  }
legend(c(1.0), c(3.8), c("(0.5-<2.5yo)", "(2.5-<4.5yo)","(4.5-<6.5yo)","(6.5-<8.5yo)","(8.5-<10.5yo)","(10.5-<12.5yo)","(12.5-<14.5yo)","(14.5-<16.5yo)","(16.5-<18.5yo)"), cex=1.1, col=1:9, pch=21:23, lty=1:3);
```

```{r CalculateLMmeans}
#Linear regression for means
lm.sc_means <- lm(means ~ age, sc_stats)
#Extract coefficients from model
coef.means <- coef(lm.sc_means)
```

<a name = "mean_plot"></a>
```{r PlotMeansAges, echo=TRUE, eval=TRUE}
#Initial plot prior to working out ggplot2, subsequently deprecated, but left for comparison
# Plot mean for age ranges
plot(ages[1:9], sc_means, main = "Mean Static Admittance By Age", xlab = "Age - Starting Age of 2 year range", ylab = "ml")
#Add linear regression line to graph
abline(lm.sc_means)
```

<a name = "mean_ggplot"></a>
```{r GGPlotMeans, echo=FALSE, eval=FALSE}
library(ggplot2)
ggplot(data=sc_stats, aes(x=age,y=means)) + geom_point()  + 
  ggtitle("Mean Middle Ear Pressure By Age (LM)") + 
  labs(x="Age - Starting Age of 2 year range", y="daPa") +
  geom_abline(intercept=coef.means[1], slope=coef.means[2])
#Compare Methods
qplot(age, means, data=sc_stats, geom = c('point', 'smooth'), method='loess')   + 
  ggtitle("Mean Middle Ear Pressure By Age (LOESS)") + 
  labs(x="Age - Starting Age of 2 year range", y="daPa") 
```
<a name = "ci_plot"></a>
```{r PlotCIs}
# Plot mean, 95% quantile, and 5% quantile curves to give 90% confidence interval
# Initial plot will give mean of static admittance 
plot(ages[1:9], sc_means, main = "90% Confidential Interval of Static Admittance By Age", xlab = "Age - Starting Age of 2 year range", ylab = "ml", ylim = c(0,max(sc_95pct)))
lm.sc_means <- lm(sc_means~ages[1:9])
abline(lm.sc_means)
# Plot 95% of static admittance 
#The next 2 lines offer different ways of plotting points on the graph
#lines(ages[1:9],sc_95pct,col=2, type = "p")
points(ages[1:9],sc_95pct,col=2)
abline(lm(sc_95pct~ages[1:9]), col = 2)
# Plot 95% of static admittance 
lines(ages[1:9],sc_5pct,col=3, type = "p")
abline(lm(sc_5pct~ages[1:9]), col = 3)
legend(c(0.5), c(2.6), c("Mean", "95% Quantile","5% Quantile"), cex=1.1, col=1:3, pch=21:23, lty=1:3);
cat("The slope of the 'mean' curve is ", round(lm.sc_means["coefficients"][[1]][[2]], 3),"ml/2 years.");cat("", sep="\n")
```
<a name = "n_plot"></a>
``` {r PlotNs}
# Check the 'n' of each year category to ensure that it is large enough to be significant
barplot(sc_n, names.arg = ages[1:9], main= paste0("Number of Observations Per Year (Minimum =", min(sc_n),")"), xlab = "Age - Starting Age of 2 year range", ylab = "n")
```
<a name = "sd_plot"></a>
``` {r PlotSDs}
# Check the 'n' of each year category to ensure that it is large enough to be significant
plot(ages[1:9], sc_sd, main= "Standard Deviation Per Year Range", xlab = "Age - Starting Age of 2 year range", ylab = "Standard Deviation (ml)")
abline(lm(sc_sd~ages[1:9]))
```

###<a name = "observations"></a>Observations###

**There are `r prettyNum(nrow(tympnorms.sanstubes), big.mark = ",")` tympanograms in the entire dataset from `r prettyNum(length(unique(tympnorms.sanstubes$Patient.Alias)), big.mark = ",")` patients.** A bar plot of the **number of observations in each bin of years** demonstrates that the smallest bin is `r min(sc_n)`. The mean value is `r prettyNum(round(mean(sc_n)), big.mark = ',')` and the maximum value is `r prettyNum(max(sc_n), big.mark = ',')`.  

####Comparisons By Age####

Examination of the **probability density function** initially demonstrated that the **means got progressively larger** as the **width of the curves broadened** over the age range without any evidence of a discontinuity. 

Plotting the **standard deviation** also indicates that the **distribution got progressively broader**, although the 10.5-12.5 age range did demonstrate and anomalously high sd.  

To address the **static admittance ~ age relationship**, these values were plotted, and this analysis demonstrated a **linear relationship with a slope of `r round(lm.sc_means["coefficients"][[1]][[2]], 3)` ml/2 years**, and an intercept of `r round(lm.sc_means["coefficients"][[1]][[1]], 3)` ml. 

**90% confidence levels increased and broadened in a linear fashion**, also.  

<br /><br /><br /><br /><br /><br /><br /><br /><br /><br />